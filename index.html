<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rudy Music Player</title>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Montserrat:wght@500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;font-family:"Montserrat",sans-serif;}
/* FIX 1: body और html को dvh पर सेट करें (मॉडर्न ब्राउज़र के लिए) */
body, html {
    height: 100dvh; 
    min-height: 100dvh; 
    overflow-x: hidden;
}
body{
    background:#000;
    color:#fff;
    display:flex;
    flex-direction:column;
}
*{-webkit-tap-highlight-color:transparent;outline:none;}
:focus{outline:none!important;}
header{display:flex;justify-content:space-between;align-items:center;padding:20px;position:relative;padding-top:max(20px,env(safe-area-inset-top));}
.greeting{display:flex;flex-direction:column;}
.greeting .username{font-family:'Roboto Slab',serif;font-size:0.9rem;color:#fff;font-weight:400;}
.greeting .time-greeting{font-size:1.4rem;font-weight:700;margin-top:3px;}
.header-right{display:flex;align-items:center;gap:15px;}
.profile-container{display:flex;align-items:center;gap:10px;}
.profile{width:38px;height:38px;border-radius:50%;overflow:hidden;cursor:pointer;border:none;background:#333;display:flex;justify-content:center;align-items:center;}
.profile img{width:100%;height:100%;object-fit:cover;}
.notification-icon{font-size:1.4rem;color:#ff4081;cursor:pointer;}
.content{flex:1;padding:0 20px 120px;overflow-y:auto;padding-top:env(safe-area-inset-top);scrollbar-width:none;}
.content::-webkit-scrollbar{display:none;}

/* Section Styles */
.section{margin-bottom:30px;}
.section-title{margin-bottom:15px;}
.section-title h2{font-size:1.4rem;font-weight:700;}

/* Playlist Container Styles */
.playlist-container{display:flex;overflow-x:auto;gap:15px;padding-bottom:10px;scrollbar-width:none;}
.playlist-container::-webkit-scrollbar{display:none;}
.playlist-card{flex:0 0 150px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:transform 0.3s ease;opacity:0;transform:translateY(20px);}
.playlist-card.show{opacity:1;transform:translateY(0);}
.playlist-card:hover{transform:scale(1.05);}
.playlist-img{width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;}
.playlist-img img{width:100%;height:100%;object-fit:cover;}
.playlist-card h4{font-size:0.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.playlist-card p{font-size:0.75rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* New Releases - Horizontal Scrolling with Multiple Rows */
.new-releases-container{display:flex;flex-direction:column;gap:20px;}
.new-releases-row{display:flex;overflow-x:auto;gap:15px;padding-bottom:10px;scrollbar-width:none;}
.new-releases-row::-webkit-scrollbar{display:none;}
.new-releases-card{flex:0 0 150px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:transform 0.3s ease;opacity:0;transform:translateY(20px);}
.new-releases-card.show{opacity:1;transform:translateY(0);}
.new-releases-card:hover{transform:scale(1.05);}
.new-releases-img{width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;}
.new-releases-img img{width:100%;height:100%;object-fit:cover;}
.new-releases-card h4{font-size:0.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.new-releases-card p{font-size:0.75rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Artists Grid */
.artists-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;}
.artist-card{display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;}
.artist-card img{width:100%;aspect-ratio:1/1;border-radius:50%;object-fit:cover;}
.artist-card h4{font-size:0.9rem;text-align:center;}

/* Library Page Styles */
.library-page{display:none;padding-top:7px; padding-bottom: 40px;}
.library-header{margin-bottom:25px;}
.library-header h1{font-size:1.8rem;font-weight:700;margin-bottom:10px;}
.library-header p{color:#aaa;font-size:0.9rem;}
.library-filters{display:flex;gap:10px;margin-bottom:20px;overflow-x:auto;padding-bottom:10px;scrollbar-width:none;}
.library-filters::-webkit-scrollbar{display:none;}
.filter-btn{padding:8px 16px;background:rgba(255,255,255,0.1);border:none;border-radius:20px;color:#fff;font-size:0.85rem;cursor:pointer;white-space:nowrap;transition:all 0.3s ease;}
.filter-btn.active{background:#ff4081;color:#fff;}
.library-songs-list{display:flex;flex-direction:column;gap:10px;}
.library-song-item{display:flex;align-items:center;gap:15px;padding:12px;border-radius:10px;cursor:pointer;transition:background 0.3s ease;}
.library-song-item:hover{background:rgba(255,255,255,0.1);}
.library-song-img{width:50px;height:50px;border-radius:8px;overflow:hidden;flex-shrink:0;position:relative;}
.library-song-img img{width:100%;height:100%;object-fit:cover;}
.library-song-info{flex:1;min-width:0;}
.library-song-info h4{font-size:0.95rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.library-song-info p{font-size:0.8rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.library-song-duration{color:#aaa;font-size:0.8rem;margin-right:10px;}
.library-play-btn{color:#ff4081;font-size:1.5rem;cursor:pointer;opacity:0;transition:opacity 0.3s ease, transform 0.2s ease;}
.library-song-item:hover .library-play-btn{opacity:1;}
.library-play-btn.playing{opacity:1;color:#ff4081;}

/* Search Page Styles */
.search-page{display:none;padding-top:20px;}
.search-container{position:relative;margin-bottom:30px;}
.search-box{width:100%;padding:15px 50px 15px 20px;background:rgba(255,255,255,0.1);border:2px solid #ff4081;border-radius:25px;color:#fff;font-size:1rem;transition:all 0.3s ease;}
.search-box:focus{border-color:#ff79b0;background:rgba(255,255,255,0.15);}
.search-icon{position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:1.5rem;color:#ff4081;cursor:pointer;}
.search-results{display:none;}
.search-result-item{display:flex;align-items:center;gap:15px;padding:12px;border-radius:10px;cursor:pointer;transition:background 0.3s ease;margin-bottom:8px;}
.search-result-item:hover{background:rgba(255,255,255,0.1);}
.search-result-img{width:50px;height:50px;border-radius:8px;overflow:hidden;flex-shrink:0;}
.search-result-img img{width:100%;height:100%;object-fit:cover;}
.search-result-info{flex:1;min-width:0;}
.search-result-info h4{font-size:0.95rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.search-result-info p{font-size:0.8rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.no-results{text-align:center;color:#aaa;padding:40px 20px;font-size:1rem;}

/* Search History Styles */
.search-history-section {
    margin-top: 20px;
}
.search-history-section h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 15px;
}
.history-item {
    display:flex;
    align-items:center;
    gap:15px;
    padding:10px 0;
    cursor:pointer;
    border-bottom:1px solid rgba(255,255,255,0.05);
}
.history-item:last-child {
    border-bottom:none;
}
.history-item-img {
    width:40px;
    height:40px;
    border-radius:5px;
    overflow:hidden;
    flex-shrink:0;
}
.history-item-img img {
    width:100%;
    height:100%;
    object-fit:cover;
}
.history-item-info {
    flex:1;
    min-width:0;
}
.history-item-info h4 {
    font-size:0.9rem;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.history-item-info p {
    font-size:0.75rem;
    color:#aaa;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.history-remove-btn {
    font-size:1.2rem;
    color:#ff4081;
    cursor:pointer;
    padding:5px; /* Increase click area */
    flex-shrink:0;
}


/* FIX 2: bottom-nav में transition जोड़ें */
.bottom-nav{
    position:fixed;
    bottom:0;
    width:100%;
    height:70px;
    display:flex;
    justify-content:space-around;
    align-items:center;
    background:rgba(0,0,0,0.9);
    backdrop-filter:blur(10px);
    border-top:1px solid rgba(255,255,255,0.1);
    z-index:100;
    padding-bottom:env(safe-area-inset-bottom);
    transition: transform 0.3s ease-in-out; /* Added for smooth hide/show */
}

/* FIX 3: Nav छिपाने के लिए क्लास */
.nav-hidden {
    transform: translateY(100%); /* Slides the nav bar 100% of its height down */
}

.bottom-nav a{color:#aaa;text-decoration:none;text-align:center;font-size:1.6rem;transition:color 0.3s ease;cursor:pointer;}
.bottom-nav a.active{color:#ff4081;}
.bottom-nav a span{display:block;font-size:0.75rem;margin-top:4px;}

/* Now playing bar. We will control its bottom position with JS */
.now-playing{
    position:fixed;
    bottom:70px;
    left:0;
    width:100%; 
    background:rgba(20,20,20,0.95);
    padding:15px 20px;
    display:none;
    align-items:center;
    justify-content:space-between;
    border-top:1px solid rgba(255,255,255,0.15);
    z-index:100;
    padding-bottom:7px;
    backdrop-filter:blur(10px);
    box-shadow:0 -5px 20px rgba(0,0,0,0.3);
    cursor:pointer;
    transition:all 0.3s ease;
}

.song-info{display:flex;align-items:center;gap:15px;flex:1;min-width:0;}
.song-cover{width:45px;height:45px;border-radius:8px;flex-shrink:0;overflow:hidden;}
.song-cover img{width:100%;height:100%;object-fit:cover;border-radius:8px;}
.song-details{min-width:0;flex:1;}
.song-details h4{font-size:1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.song-details p{font-size:0.8rem;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.player-controls{display:flex;align-items:center;gap:20px;flex-shrink:0;}
.player-controls i{font-size:1.4rem;cursor:pointer;transition:color 0.3s ease;}
.player-controls .play-pause{font-size:2.2rem;}
.seek-bar-container{position:absolute;top:-3px;left:0;width:100%;height:3px;cursor:pointer;}
.seek-bar{width:100%;height:100%;background:rgba(255,255,255,0.2);position:relative;}
.seek-bar-progress{height:100%;background:#ff4081;width:0%;transition:width 0.1s linear;}
.seek-bar-handle{position:absolute;top:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:#fff;border-radius:50%;opacity:0;transition:opacity 0.2s ease;box-shadow:0 0 5px rgba(0,0,0,0.5);}
.full-player{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a1a 0%,#000 100%);z-index:1000;display:none;flex-direction:column;overflow:hidden;padding:max(20px,env(safe-area-inset-top)) 20px max(90px,env(safe-area-inset-bottom));}
.full-player.show{display:flex;animation:fadeIn 0.3s ease;}
.full-player-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;margin-bottom:10px;}
.full-player-header i{font-size:1.5rem;cursor:pointer;color:#fff;}
.full-player-cover{width:500px;height:500px;max-width:80vw;max-height:80vw;margin:40px auto 30px;border-radius:5%;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.full-player-cover img{width:100%;height:100%;border-radius:5%;object-fit:contain;}
.full-player-song-info{text-align:center;margin-bottom:30px;}
.full-player-song-info h2{font-size:1.8rem;margin-bottom:8px;font-weight:700;}
.full-player-song-info p{font-size:1.2rem;color:#aaa;}
.full-player-seek-container{margin-bottom:30px;}
.full-player-time-info{display:flex;justify-content:space-between;font-size:0.8rem;color:#aaa;margin-bottom:10px;}
.full-player-seek-bar{width:100%;height:6px;background:rgba(255,255,255,0.2);border-radius:2px;position:relative;cursor:pointer;}
.full-player-seek-progress{height:100%;background:#ff4081;width:0%;border-radius:2px;transition:width 0.1s linear;position:relative;}
.full-player-seek-handle{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;background:#fff;border-radius:50%;opacity:0;transition:opacity 0.2s ease;box-shadow:0 0 5px rgba(0,0,0,0.5);}
.full-player-controls{display:flex;justify-content:center;align-items:center;gap:25px;margin-top:5px;}
.full-player-controls i{font-size:2rem;cursor:pointer;transition:color 0.3s ease;}
.full-player-controls .full-player-play-pause{font-size:3.5rem;background:#fff;color:#000;border-radius:50%;padding:10px;box-shadow:0 0 10px rgba(255,255,255,0.3);}
.full-player-controls .full-player-prev-next{font-size:2.2rem;color:#fff;background:#000;border:2px solid #fff;border-radius:50%;padding:8px;}
.full-player-controls .bx-shuffle,.full-player-controls .bx-repeat{font-size:1.8rem;color:#aaa;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@media(max-width:768px){.full-player-cover{width:350px;height:350px;margin:30px auto 20px;}.full-player-song-info h2{font-size:1.5rem;}.full-player-song-info p{font-size:1rem;}}
@media(max-width:480px){.full-player-cover{width:280px;height:280px;margin:20px auto 15px;}.full-player-controls{gap:20px;}.full-player-controls .full-player-play-pause{font-size:3rem;padding:8px;}.full-player-controls .full-player-prev-next{font-size:1.8rem;padding:6px;}}

</style>
</head>
<body>
<header>
<div class="greeting">
  <div class="username" id="username">👋🏻Hello Moose army</div>
  <div class="time-greeting" id="time-greeting">Good Morning 🌞</div>
</div>
<div class="header-right">
  <div class="profile-container">
    <i class='bx bx-bell notification-icon'></i>
    <div class="profile"><img src="https://i.pravatar.cc/150?img=3" alt="Profile"></div>
  </div>
</div>
</header>

<div class="content" id="content">
  <div class="home-page" id="homePage"></div>
  
  <div class="search-page" id="searchPage">
    <div class="search-container">
      <input type="text" class="search-box" id="searchBox" placeholder="Search for songs, artists..." autocomplete="off">
      <i class='bx bx-search search-icon' id="searchIcon"></i>
    </div>
    
    <div class="search-results" id="searchResults">
      </div>
    
    <div class="search-history-section" id="searchHistorySection">
      <h3>Recent Searches</h3>
      <div id="historyList">
        </div>
    </div>
  </div>
  
  <!-- NEW LIBRARY PAGE -->
  <div class="library-page" id="libraryPage">
    <div class="library-header">
      <h1>Your Library</h1>
      <p>All your favorite songs in one place</p>
    </div>
    
    <div class="library-filters">
      <button class="filter-btn active" data-filter="all">All Songs</button>
      <button class="filter-btn" data-filter="recent">Recently Played</button>
      <button class="filter-btn" data-filter="favorites">Favorites</button>
    </div>
    
    <div class="library-songs-list" id="librarySongsList">
      <!-- Songs will be dynamically added here -->
    </div>
  </div>
</div>

<div class="full-player" id="fullPlayer">
  <div class="full-player-header">
    <i class='bx bx-chevron-down' id="closeFullPlayer"></i>
    <i class='bx bx-dots-horizontal-rounded'></i>
  </div>
  <div class="full-player-cover">
    <img id="fullPlayerCover" src="https://i.scdn.co/image/ab67616d0000b2739e1b7b71f3e0a05a0ccad5a0" alt="Album Cover">
  </div>
  <div class="full-player-song-info">
    <h2 id="fullPlayerTitle">Song Title</h2>
    <p id="fullPlayerArtist">Artist Name</p>
  </div>
  <div class="full-player-seek-container">
    <div class="full-player-time-info">
      <span id="currentTime">0:00</span>
      <span id="totalTime">0:00</span>
    </div>
    <div class="full-player-seek-bar" id="fullPlayerSeekBar">
      <div class="full-player-seek-progress" id="fullPlayerSeekProgress"></div>
      <div class="full-player-seek-handle" id="fullPlayerSeekHandle"></div>
    </div>
  </div>
  <div class="full-player-controls">
    <i class='bx bx-shuffle'></i>
    <i class='bx bx-skip-previous full-player-prev-next' id="fullPlayerPrev"></i>
    <i class='bx bx-play full-player-play-pause' id="fullPlayerPlayPause"></i>
    <i class='bx bx-skip-next full-player-prev-next' id="fullPlayerNext"></i>
    <i class='bx bx-repeat'></i>
  </div>
</div>

<div class="now-playing" id="nowPlaying">
  <div class="seek-bar-container">
    <div class="seek-bar" id="seekBar">
      <div class="seek-bar-progress" id="seekBarProgress"></div>
      <div class="seek-bar-handle" id="seekBarHandle"></div>
    </div>
  </div>
  <div class="song-info">
    <div class="song-cover"><img id="miniPlayerCover" src="https://i.scdn.co/image/ab67616d0000b2739e1b7b71f3e0a05a0ccad5a0" alt=""></div>
    <div class="song-details">
      <h4 id="miniPlayerTitle">Title</h4>
      <p id="miniPlayerArtist">Artist</p>
    </div>
  </div>
  <div class="player-controls">
    <i class='bx bx-skip-previous' id="prev"></i>
    <i class='bx bx-play-circle play-pause' id="playPauseBtn"></i>
    <i class='bx bx-skip-next' id="next"></i>
  </div>
</div>

<nav class="bottom-nav">
  <a class="active" data-page="home"><i class='bx bx-home'></i><span>Home</span></a>
  <a data-page="search"><i class='bx bx-search'></i><span>Search</span></a>
  <a data-page="library"><i class='bx bx-library'></i><span>Library</span></a>
</nav>

<script>
// === MUSIC DATA ===
let musicData = {
    newReleases: [
  { "title": "Regret", "img": "https://i.postimg.cc/vHKWn07R/51-Bvif-CGm-L-UXNa-N-FMjpg-QL85.jpg", "audio": "https://files.catbox.moe/loytir.mp3" },
  { "title": "Watch Out", "img": "https://i.postimg.cc/P56K2yMh/Watch-Out-Punjabi-2023-20231112095134-500x500.jpg", "audio": "https://files.catbox.moe/ytkn3o.mp3" },
  { "title": "Syl", "img": "https://i.postimg.cc/JnXq7LCn/55994.webp", "audio": "https://files.catbox.moe/sw6wcy.mp3" },
  { "title": "Roti", "img": "https://i.postimg.cc/nrYG7Gzm/Roti-Punjabi-2020-20200506103038-500x500.jpg", "audio": "https://files.catbox.moe/9jflrl.mp3" },
  { "title": "So High", "img": "https://i.postimg.cc/26y2Dhkb/s66.jpg", "audio": "https://files.catbox.moe/0f8nth.mp3" },
  { "title": "TtSm", "img": "https://i.postimg.cc/KzS2WG76/s6.jpg", "audio": "" },
  { "title": "Lock", "img": "https://i.postimg.cc/c4MrMjW1/s7.jpg", "audio": "" },
  { "title": "Jjmw", "img": "https://i.postimg.cc/jSbyRPxM/s73.jpg", "audio": "" },
  { "title": "Attach", "img": "https://i.postimg.cc/gJPCDMmH/s8.jpg", "audio": "" },
  { "title": "Dilemma", "img": "https://i.postimg.cc/FsK2Dk5y/s9.jpg", "audio": "" },
  { "title": "410", "img": "https://i.postimg.cc/FzHnW8qQ/s10.jpg", "audio": "" },
  { "title": "Chorni", "img": "https://i.postimg.cc/hPh59FTC/s11.jpg", "audio": "" },
  { "title": "Mera Name", "img": "https://i.postimg.cc/2ShTwC6n/s12.jpg", "audio": "" },
  { "title": "Dark Love", "img": "https://i.postimg.cc/FKhbVcwd/s13.jpg", "audio": "" },
  { "title": "Moose Jutt. Jailaan", "img": "https://i.postimg.cc/Vv0XkF02/s14.jpg", "audio": "" },
  { "title": "Paapi", "img": "https://i.postimg.cc/P5yyc2Wb/s15.jpg", "audio": "" },
  { "title": "Level", "img": "https://i.postimg.cc/vT5Lvz8x/s16.jpg", "audio": "" },
  { "title": "The Last Ride", "img": "https://i.postimg.cc/vT5Lvz8x/s16.jpg", "audio": "" },
  { "title": "Scapegoat", "img": "https://i.postimg.cc/yN5m45kk/s18.jpg", "audio": "" },
  { "title": "Fuck em all", "img": "https://i.postimg.cc/DyFqT1y1/s19.jpg", "audio": "" },
  { "title": "Youngest In Charge", "img": "https://i.postimg.cc/cJK3mmTb/s20.jpg", "audio": "" },
  { "title": "SatiSfy", "img": "https://i.postimg.cc/QCNx6NhD/s21.jpg", "audio": "" },
  { "title": "Moh", "img": "https://i.postimg.cc/QCNx6NhD/s21.jpg", "audio": "" },
  { "title": "Baapu", "img": "https://i.postimg.cc/76Hk4Bdy/s23.jpg", "audio": "" },
  { "title": "Saab", "img": "https://i.postimg.cc/8kYqXP1w/s24.jpg", "audio": "" },
  { "title": "Who's Bad", "img": "https://i.postimg.cc/8550wxx7/s25.jpg", "audio": "" },
  { "title": "Sin", "img": "https://i.postimg.cc/595sL4X5/s26.jpg", "audio": "" },
  { "title": "Chosen", "img": "https://i.postimg.cc/FR5xk8mB/s27.jpg", "audio": "" },
  { "title": "Panjab", "img": "https://i.postimg.cc/0yzGWPy3/s28.jpg", "audio": "" },
  { "title": "Bhai Bhai", "img": "https://i.postimg.cc/NFGm1wn8/s29.jpg", "audio": "" },
  { "title": "Bad", "img": "https://i.postimg.cc/HLQyRxDw/s30.jpg", "audio": "" },
  { "title": "Game", "img": "https://i.postimg.cc/448hrqMj/s31.jpg", "audio": "" },
  { "title": "My Block", "img": "https://i.postimg.cc/xC6cVNsm/s32.jpg", "audio": "" },
  { "title": "Doctor", "img": "https://i.postimg.cc/xCmntkw1/s33.jpg", "audio": "" },
  { "title": "Sanju", "img": "https://i.postimg.cc/QxhhJd0V/s34.jpg", "audio": "" },
  { "title": "Bambiha Bole", "img": "https://i.postimg.cc/tgZj4ZCm/s35.jpg", "audio": "" },
  { "title": "Tribeyan da Putt", "img": "https://i.postimg.cc/bNyf2FwN/s36.jpg", "audio": "" },
  { "title": "8 Cylinder", "img": "https://i.postimg.cc/B6TRjxWm/s38.jpg", "audio": "" },
  { "title": "911", "img": "https://i.postimg.cc/SNNHK2g7/s39.jpg", "audio": "" },
  { "title": "Old Skool", "img": "https://i.postimg.cc/sXrNCvBQ/s40.jpg", "audio": "" },
  { "title": "Dhakka", "img": "https://i.postimg.cc/5NRKNPHZ/s41.jpg", "audio": "" },
  { "title": "Forget About It", "img": "https://i.postimg.cc/QCnmCtM7/s42.jpg", "audio": "" },
  { "title": "47", "img": "https://i.postimg.cc/QCnmCtM7/s42.jpg", "audio": "" },
  { "title": "B-town", "img": "https://i.postimg.cc/FzqbmBPj/s44.jpg", "audio": "" },
  { "title": "Same Beef", "img": "https://i.postimg.cc/YCQNK8Qd/s45.jpg", "audio": "" },
  { "title": "Dogar", "img": "https://i.postimg.cc/HxvX4NCH/s46.jpg", "audio": "" },
  { "title": "Homicide", "img": "https://i.postimg.cc/fy0t7TKL/s47.jpg", "audio": "" },
  { "title": "Hatyrar", "img": "https://i.postimg.cc/BnCgPMtj/s49.jpg", "audio": "" },
  { "title": "Poison", "img": "https://i.postimg.cc/HxF41Nv3/s50.jpg", "audio": "" },
  { "title": "Mafia Style", "img": "https://i.postimg.cc/W1smVg8w/s51.jpg", "audio": "" },
  { "title": "East Side Flow", "img": "https://i.postimg.cc/L5dfb1hb/s52.jpg", "audio": "" },
  { "title": "Outlow", "img": "https://i.postimg.cc/gjPXDbBS/s54.jpg", "audio": "" },
  { "title": "Legend", "img": "https://i.postimg.cc/kg5Vwcf6/s55.jpg", "audio": "" },
  { "title": "Dollar", "img": "https://i.postimg.cc/zv5vhSyB/s56.jpg", "audio": "" },
  { "title": "Badmashi", "img": "https://i.postimg.cc/nc3rsmpL/s57.jpg", "audio": "" },
  { "title": "Famous", "img": "https://i.postimg.cc/Y9NqtGdB/s58.jpg", "audio": "" },
  { "title": "Tochan", "img": "https://i.postimg.cc/DzL7c4kX/s59.jpg", "audio": "" },
  { "title": "It's All About You", "img": "https://i.postimg.cc/sDLyd43y/s60.jpg", "audio": "" },
  { "title": "Just Listen", "img": "https://i.postimg.cc/fyr4sMnf/s61.jpg", "audio": "" },
  { "title": "Lifestyle", "img": "https://i.postimg.cc/BnDWWWhx/s62.jpg", "audio": "" },
  { "title": "Issa Jatt", "img": "https://i.postimg.cc/BbyzyNHR/s63.jpg", "audio": "" },
  { "title": "Mustang", "img": "https://i.postimg.cc/nzhwhN1S/s64.jpg", "audio": "" },
  { "title": "Velly Banda", "img": "https://i.postimg.cc/nhfRDXkK/s65.jpg", "audio": "" },
  { "title": "G Wagon", "img": "https://i.postimg.cc/7h7RF09T/s67.jpg", "audio": "" },
  { "title": "Taara", "img": "https://i.postimg.cc/sg3LLBhX/s68.jpg", "audio": "" },
  { "title": "Yes I Am Student", "img": "https://i.postimg.cc/d3MHjDFv/s69.jpg", "audio": "" },
  { "title": "Rassian Tank", "img": "https://i.postimg.cc/DyTpWW5B/s70.jpg", "audio": "" },
   { "title": "PBX 1", "img": "https://i.postimg.cc/xCdJpP0p/s2.webp", "audio": "" },
  { "title": "No Name", "img": "https://i.postimg.cc/0yq61vkq/s3.jpg", "audio": "" },
  { "title": "Snitches Get Stitches", "img": "https://i.postimg.cc/nL3MmQvz/s5.jpg", "audio": "" },
  { "title": "Mooseprint", "img": "https://i.postimg.cc/HxKxZDvc/s4.jpg", "audio": "" },
  { "title": "Drippy", "img": "https://i.postimg.cc/2S8DZ9Tv/s72.jpg", "audio": "" },
  { "title": "Vaar", "img": "https://i.postimg.cc/CxmwrpdJ/s71.jpg", "audio": "" },
  { "title": "Cadilac", "img": "https://i.postimg.cc/wBCZ0wcY/s74.jpg", "audio": "" },
  { "title": "Yaariyaan", "img": "https://i.postimg.cc/qBXSxXNF/s75.jpg", "audio": "" },
  { "title": "Jaan", "img": "https://i.postimg.cc/6pSmpMP6/s76.jpg", "audio": "" },
  { "title": "Athra Style", "img": "https://i.postimg.cc/Pxb3KT5D/s77.jpg", "audio": "" },
  { "title": "Unfuckwithable", "img": "https://i.postimg.cc/3Rrm5TZW/s79.jpg", "audio": "" },
  { "title": "Gwacheya Gurbakash", "img": "https://i.postimg.cc/SQr1MS50/s78.jpg", "audio": "" }
  ],
    mixesForYou: [
        { "title": "Mix 1", "img": "https://picsum.photos/200?random=4", "artist": "Artist G", "audio": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
        { "title": "Mix 2", "img": "https://picsum.photos/200?random=5", "artist": "Artist H", "audio": "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }
    ],
    artists: []
};

// === PLAYER STATE ===
let currentPlaylist = [];
let currentSongIndex = 0;
let isPlaying = false;

// Favorites storage
let favoriteSongs = JSON.parse(localStorage.getItem("favoriteSongs") || "[]");

// === BACK NAVIGATION STATE ===
let previousPage = 'home'; // Track which page we came from

// === GREETING ===
function updateGreeting(){
    const greetingEl=document.getElementById('time-greeting');
    const now=new Date();
    const hour=now.getHours();
    let greetingText="";
    if(hour>=5 && hour<12) greetingText="Good Morning 🌞";
    else if(hour>=12 && hour<17) greetingText="Good Afternoon ☀️";
    else if(hour>=17 && hour<21) greetingText="Good Evening 🌙";
    else greetingText="Good Night 🌙";
    greetingText+=" | "+now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    greetingEl.textContent=greetingText;
}
setInterval(updateGreeting,1000);
updateGreeting();

// === PAGE NAVIGATION ===
function showPage(page) {
    // Hide all pages
    document.getElementById('homePage').style.display = 'none';
    document.getElementById('searchPage').style.display = 'none';
    document.getElementById('libraryPage').style.display = 'none';
    
    // Show selected page
    if (page === 'home') {
        document.getElementById('homePage').style.display = 'block';
        previousPage = 'home';
    } else if (page === 'search') {
        document.getElementById('searchPage').style.display = 'block';
        previousPage = 'search';
        updateSearchHistoryUI(); // Show history when search page is opened
    } else if (page === 'library') {
        document.getElementById('libraryPage').style.display = 'block';
        previousPage = 'library';
        updateLibraryUI(); // Refresh library when opened
    }
}

// === POPULATE ALL SECTIONS ===
function populateAllSections() {
    const homePage = document.getElementById('homePage');
    homePage.innerHTML = ''; // Clear existing content
    
    if (musicData.newReleases && musicData.newReleases.length > 0) {
        createSection("New Releases", musicData.newReleases, "playlist", homePage);
    }
    
    if (musicData.mixesForYou && musicData.mixesForYou.length > 0) {
        createSection("Mixes For You", musicData.mixesForYou, "playlist", homePage);
    }
    
    if (musicData.artists && musicData.artists.length > 0) {
        createSection("Artists", musicData.artists, "artists", homePage);
    }
    
    // Remove the old recently played section from home page
    // Now we'll only show it in library
}

// === CREATE SECTION (Functions for creating dynamic content) ===
function createSection(title, items, type, container){
    const section=document.createElement('div'); 
    section.classList.add('section');
    
    const sectionTitle=document.createElement('div'); 
    sectionTitle.classList.add('section-title');
    
    const h2=document.createElement('h2'); 
    h2.textContent=title;
    sectionTitle.appendChild(h2); 
    section.appendChild(sectionTitle);

    if(type==="playlist") {
        // For New Releases section - use horizontal scrolling rows with Multiple Rows
        if(title === "New Releases") {
            const releasesContainer = document.createElement('div');
            releasesContainer.classList.add('new-releases-container');
            
            // Split items into rows of 10 songs each (up to 30 songs)
            const rows = [];
            for (let i = 0; i < Math.min(items.length, 30); i += 10) {
                rows.push(items.slice(i, i + 10));
            }
            
            // Create a horizontal scrolling row for each group of 10 songs
            rows.forEach((rowItems, rowIndex) => {
                const row = document.createElement('div');
                row.classList.add('new-releases-row');
                
                rowItems.forEach((item, index) => {
                    const card=document.createElement('div');
                    card.classList.add('new-releases-card');
                    card.innerHTML=`<div class="new-releases-img"><img src="${item.img}" alt=""></div><h4>${item.title}</h4><p>${item.artist}</p>`;
                    row.appendChild(card);
                    card.addEventListener('click',()=>{
                        currentPlaylist = items;
                        currentSongIndex = rowIndex * 10 + index;
                        playSong(item);
                    });
                    setTimeout(()=>card.classList.add('show'), Math.random()*300);
                });
                
                releasesContainer.appendChild(row);
            });
            
            section.appendChild(releasesContainer);
        } 
        // For other playlist sections - use original single row layout
        else {
            const playlistContainer=document.createElement('div');
            playlistContainer.classList.add('playlist-container');

            items.forEach((item, index)=>{
                const card=document.createElement('div');
                card.classList.add('playlist-card');
                card.innerHTML=`<div class="playlist-img"><img src="${item.img}" alt=""></div><h4>${item.title}</h4><p>${item.artist}</p>`;
                playlistContainer.appendChild(card);
                card.addEventListener('click',()=>{
                    currentPlaylist = items;
                    currentSongIndex = index;
                    playSong(item);
                });
                setTimeout(()=>card.classList.add('show'), Math.random()*300);
            });
            section.appendChild(playlistContainer);
        }
    } else if(type==="artists") {
        const artistsContainer=document.createElement('div');
        artistsContainer.classList.add('artists-grid');

        items.forEach(item=>{
            const card=document.createElement('div');
            card.classList.add('artist-card');
            card.innerHTML=`<img src="${item.img}" alt=""><h4>${item.name}</h4>`;
            artistsContainer.appendChild(card);
        });
        section.appendChild(artistsContainer);
    }
    
    container.appendChild(section);
}

// === LIBRARY FUNCTIONS ===
function populateLibrary() {
    // Combine all songs from different sections
    const allSongs = [
        ...(musicData.newReleases || []),
        ...(musicData.mixesForYou || [])
    ];
    
    updateLibraryUI(allSongs);
}

function updateLibraryUI(songs = null) {
    const librarySongsList = document.getElementById('librarySongsList');
    librarySongsList.innerHTML = '';
    
    // If no songs provided, get all songs
    if (!songs) {
        songs = [
            ...(musicData.newReleases || []),
            ...(musicData.mixesForYou || [])
        ];
    }
    
    if (songs.length === 0) {
        librarySongsList.innerHTML = '<div class="no-results">No songs found in your library</div>';
        return;
    }
    
    songs.forEach((song, index) => {
        const songItem = document.createElement('div');
        songItem.classList.add('library-song-item');
        
        // Check if this song is currently playing
        const isCurrentSong = audio.src && audio.src.includes(song.audio);
        const playIcon = isCurrentSong && isPlaying ? 'bx-pause' : 'bx-play';
        
        // Check if song is in favorites
        const isFavorite = favoriteSongs.some(fav => fav.audio === song.audio);
        const favoriteIcon = isFavorite ? 'bxs-heart' : 'bx-heart';
        
        songItem.innerHTML = `
            <div class="library-song-img">
                <img src="${song.img}" alt="${song.title}">
            </div>
            <div class="library-song-info">
                <h4>${song.title}</h4>
                <p>${song.artist}</p>
            </div>
            <span class="library-song-duration">3:45</span>
            <i class='bx ${favoriteIcon} library-favorite-btn' style="color: ${isFavorite ? '#ff4081' : '#aaa'}; margin-right: 10px;"></i>
            <i class='bx ${playIcon} library-play-btn ${isCurrentSong && isPlaying ? 'playing' : ''}'></i>
        `;
        
        // Add click event to play song
        songItem.addEventListener('click', function(e) {
            if (!e.target.classList.contains('library-play-btn') && !e.target.classList.contains('library-favorite-btn')) {
                currentPlaylist = songs;
                currentSongIndex = index;
                playSong(song);
                updateLibraryPlayButtons(); // Update all play buttons
            }
        });
        
        // Add click event to play button
        const playBtn = songItem.querySelector('.library-play-btn');
        playBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            if (isCurrentSong) {
                // If this is the current song, toggle play/pause
                togglePlayPause();
            } else {
                // If this is a different song, play it
                currentPlaylist = songs;
                currentSongIndex = index;
                playSong(song);
            }
            updateLibraryPlayButtons(); // Update all play buttons
        });
        
        // Add click event to favorite button
        const favoriteBtn = songItem.querySelector('.library-favorite-btn');
        favoriteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleFavorite(song);
            updateLibraryUI(songs); // Refresh to show updated favorites
        });
        
        librarySongsList.appendChild(songItem);
    });
}

function updateLibraryPlayButtons() {
    const playButtons = document.querySelectorAll('.library-play-btn');
    playButtons.forEach(btn => {
        btn.classList.remove('bx-play', 'bx-pause', 'playing');
        btn.classList.add('bx-play');
    });
    
    // Update the current playing song button
    if (audio.src && currentPlaylist[currentSongIndex]) {
        const currentSongAudio = currentPlaylist[currentSongIndex].audio;
        const currentSongItems = document.querySelectorAll('.library-song-item');
        
        currentSongItems.forEach(item => {
            const img = item.querySelector('img');
            if (img && img.src.includes(currentPlaylist[currentSongIndex].img)) {
                const playBtn = item.querySelector('.library-play-btn');
                if (playBtn) {
                    playBtn.classList.remove('bx-play', 'bx-pause');
                    playBtn.classList.add(isPlaying ? 'bx-pause' : 'bx-play', 'playing');
                }
            }
        });
    }
}

// === FAVORITES FUNCTIONALITY ===
function toggleFavorite(song) {
    const index = favoriteSongs.findIndex(fav => fav.audio === song.audio);
    
    if (index === -1) {
        // Add to favorites
        favoriteSongs.push(song);
    } else {
        // Remove from favorites
        favoriteSongs.splice(index, 1);
    }
    
    // Save to localStorage
    localStorage.setItem("favoriteSongs", JSON.stringify(favoriteSongs));
}

// === RECENTLY PLAYED ===
let recentlyPlayed = JSON.parse(localStorage.getItem("recentlyPlayed")||"[]");

// === SEARCH HISTORY FUNCTIONS ===
let searchHistory = JSON.parse(localStorage.getItem("searchHistory")||"[]");

function saveSearchHistory() {
    localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
}

function addToSearchHistory(song) {
    // 1. Check if the song is already in history (by audio URL as unique ID)
    searchHistory = searchHistory.filter(s => s.audio !== song.audio);
    
    // 2. Add the new song to the beginning
    searchHistory.unshift({
        title: song.title,
        artist: song.artist,
        img: song.img,
        audio: song.audio
    });
    
    // 3. Keep history length manageable (e.g., max 20 songs)
    if (searchHistory.length > 20) {
        searchHistory.pop();
    }
    
    saveSearchHistory();
    // Update UI if on search page and no search query is active
    if (!searchBox.value) {
        updateSearchHistoryUI();
    }
}

function removeSearchHistoryItem(audioUrl) {
    searchHistory = searchHistory.filter(s => s.audio !== audioUrl);
    saveSearchHistory();
    updateSearchHistoryUI(); // Refresh the list
}

function updateSearchHistoryUI() {
    const historyList = document.getElementById('historyList');
    const historySection = document.getElementById('searchHistorySection');
    
    historyList.innerHTML = '';

    if (searchBox.value.length > 0) {
        // Hide history when user is typing a query
        historySection.style.display = 'none';
        return;
    }
    
    if (searchHistory.length === 0) {
        historySection.style.display = 'none';
        return;
    }

    historySection.style.display = 'block';

    searchHistory.forEach(song => {
        const item = document.createElement('div');
        item.classList.add('history-item');
        item.dataset.audioUrl = song.audio; // Store URL for removal
        
        item.innerHTML = `
            <div class="history-item-img">
                <img src="${song.img}" alt="${song.title}">
            </div>
            <div class="history-item-info">
                <h4>${song.title}</h4>
                <p>${song.artist}</p>
            </div>
            <i class='bx bx-x history-remove-btn'></i>
        `;
        
        // Add event listener to play song (excluding the remove button)
        item.querySelector('.history-item-info').parentElement.addEventListener('click', (e) => {
            if (!e.target.classList.contains('history-remove-btn')) {
                // Find the song in the main music data to get all properties if needed
                const allSongs = [
                    ...(musicData.newReleases || []),
                    ...(musicData.mixesForYou || [])
                ];
                const fullSong = allSongs.find(s => s.audio === song.audio) || song;
                
                // Set current playlist to a dummy list containing only the history song for playback
                currentPlaylist = [fullSong]; 
                currentSongIndex = 0;
                playSong(fullSong);
            }
        });
        
        // Add event listener for removal
        item.querySelector('.history-remove-btn').addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the play action
            removeSearchHistoryItem(song.audio);
        });
        
        historyList.appendChild(item);
    });
}

// === SEARCH FUNCTIONALITY ===
function searchSongs(query) {
    const searchResults = document.getElementById('searchResults');
    const searchHistorySection = document.getElementById('searchHistorySection');
    
    if (!query || query.length < 1) {
        searchResults.style.display = 'none';
        updateSearchHistoryUI(); // Show history when query is cleared
        return;
    }
    
    searchResults.innerHTML = '';
    searchHistorySection.style.display = 'none'; // Hide history while searching
    
    // Get all songs from new releases and mixes
    const allSongs = [
        ...(musicData.newReleases || []),
        ...(musicData.mixesForYou || [])
    ];
    
    // Filter songs based on query (search in title and artist)
    const filteredSongs = allSongs.filter(song => {
        const searchTerm = query.toLowerCase();
        return (
            song.title.toLowerCase().includes(searchTerm) ||
            song.artist.toLowerCase().includes(searchTerm)
        );
    });
    
    if (filteredSongs.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No songs found</div>';
    } else {
        filteredSongs.forEach((song, index) => {
            const resultItem = document.createElement('div');
            resultItem.classList.add('search-result-item');
            resultItem.innerHTML = `
                <div class="search-result-img">
                    <img src="${song.img}" alt="${song.title}">
                </div>
                <div class="search-result-info">
                    <h4>${song.title}</h4>
                    <p>${song.artist}</p>
                </div>
            `;
            resultItem.addEventListener('click', () => {
                currentPlaylist = filteredSongs;
                currentSongIndex = index;
                playSong(song);
                addToSearchHistory(song); // Add searched song to history
            });
            searchResults.appendChild(resultItem);
        });
    }
    
    searchResults.style.display = 'block';
}

// === PLAYER ===
const nowPlayingBar=document.getElementById('nowPlaying');
const playPauseBtn=document.getElementById('playPauseBtn');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const miniPlayerCover = document.getElementById('miniPlayerCover');
const miniPlayerTitle = document.getElementById('miniPlayerTitle');
const miniPlayerArtist = document.getElementById('miniPlayerArtist');
const seekBar = document.getElementById('seekBar');
const seekBarProgress = document.getElementById('seekBarProgress');
const seekBarHandle = document.getElementById('seekBarHandle');

// Full Player Elements
const fullPlayer = document.getElementById('fullPlayer');
const closeFullPlayerBtn = document.getElementById('closeFullPlayer');
const fullPlayerCover = document.getElementById('fullPlayerCover');
const fullPlayerTitle = document.getElementById('fullPlayerTitle');
const fullPlayerArtist = document.getElementById('fullPlayerArtist');
const fullPlayerPlayPause = document.getElementById('fullPlayerPlayPause');
const fullPlayerPrev = document.getElementById('fullPlayerPrev');
const fullPlayerNext = document.getElementById('fullPlayerNext');
const fullPlayerSeekBar = document.getElementById('fullPlayerSeekBar');
const fullPlayerSeekProgress = document.getElementById('fullPlayerSeekProgress');
const fullPlayerSeekHandle = document.getElementById('fullPlayerSeekHandle');
const currentTimeEl = document.getElementById('currentTime');
const totalTimeEl = document.getElementById('totalTime');

let audio=new Audio();
let isSeeking = false;
let isFullPlayerSeeking = false;

// Format time as MM:SS
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// Prevent body scroll when full player is open
function preventBodyScroll(prevent) {
    if (prevent) {
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
    }
}

function playSong(song){
    if (!song.audio) {
        console.error('No audio URL provided for song:', song.title);
        return;
    }
    
    audio.src=song.audio;
    audio.play().catch(error => {
        console.error('Error playing audio:', error);
    });
    isPlaying = true;
    
    // Update mini player - FIX: Properly update all elements
    miniPlayerCover.src = song.img;
    miniPlayerTitle.textContent = song.title;
    miniPlayerArtist.textContent = song.artist || "";
    
    // Make sure now playing bar is visible
    nowPlayingBar.style.display = "flex";
    nowPlayingBar.style.opacity = "1";
    nowPlayingBar.style.transform = "translateY(0)";
    
    playPauseBtn.classList.replace('bx-play-circle','bx-pause-circle');
    
    // Update full player
    fullPlayerCover.src = song.img;
    fullPlayerTitle.textContent = song.title;
    fullPlayerArtist.textContent = song.artist || "";
    fullPlayerPlayPause.classList.replace('bx-play','bx-pause');
    fullPlayerPlayPause.classList.add('full-player-play-pause');

    // Update library play buttons
    updateLibraryPlayButtons();

    // Update recently played
    recentlyPlayed = recentlyPlayed.filter(s=>s.audio!==song.audio);
    recentlyPlayed.unshift(song);
    if(recentlyPlayed.length>12) recentlyPlayed.pop();
    localStorage.setItem("recentlyPlayed",JSON.stringify(recentlyPlayed));
}

// === PLAY/PAUSE ===
function togglePlayPause() {
    if(audio.src){
        if(audio.paused){ 
            audio.play().catch(error => {
                console.error('Error playing audio:', error);
            }); 
            playPauseBtn.classList.replace('bx-play-circle','bx-pause-circle'); 
            fullPlayerPlayPause.classList.replace('bx-play','bx-pause');
            isPlaying = true;
        } else { 
            audio.pause(); 
            playPauseBtn.classList.replace('bx-pause-circle','bx-play-circle'); 
            fullPlayerPlayPause.classList.replace('bx-pause','bx-play');
            isPlaying = false;
        }
        // Update library play buttons
        updateLibraryPlayButtons();
    }
}

playPauseBtn.addEventListener('click', togglePlayPause);
fullPlayerPlayPause.addEventListener('click', togglePlayPause);

// === NEXT/PREVIOUS BUTTONS ===
function playPreviousSong() {
    if (currentPlaylist.length === 0) return;
    
    currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
    const song = currentPlaylist[currentSongIndex];
    playSong(song);
}

function playNextSong() {
    if (currentPlaylist.length === 0) return;
    
    currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
    const song = currentPlaylist[currentSongIndex];
    playSong(song);
}

prevBtn.addEventListener('click', playPreviousSong);
fullPlayerPrev.addEventListener('click', playPreviousSong);

nextBtn.addEventListener('click', playNextSong);
fullPlayerNext.addEventListener('click', playNextSong);

// Auto-play next song when current song ends
audio.addEventListener('ended', () => {
    playNextSong();
});

// === FULL PLAYER ===
function showFullPlayer() {
    fullPlayer.classList.add('show');
    preventBodyScroll(true);
    // Push a new state to history
    history.pushState({ fullPlayerOpen: true }, "");
}

function hideFullPlayer() {
    fullPlayer.classList.remove('show');
    preventBodyScroll(false);
    // Go back to the previous page
    history.back();
}

closeFullPlayerBtn.addEventListener('click', hideFullPlayer);

// Click anywhere on mini player (except controls) to open full player
nowPlayingBar.addEventListener('click', function(e) {
    // Only open full player if not clicking on control buttons
    if (!e.target.closest('.player-controls')) {
        showFullPlayer();
    }
});

// === SEEK BAR FUNCTIONALITY ===
function updateSeekBar() {
    if (!isSeeking && audio.duration) {
        const progress = (audio.currentTime / audio.duration) * 100;
        seekBarProgress.style.width = `${progress}%`;
        seekBarHandle.style.left = `${progress}%`;
    }
    
    if (!isFullPlayerSeeking && audio.duration) {
        const progress = (audio.currentTime / audio.duration) * 100;
        fullPlayerSeekProgress.style.width = `${progress}%`;
        fullPlayerSeekHandle.style.left = `${progress}%`;
        
        currentTimeEl.textContent = formatTime(audio.currentTime);
        totalTimeEl.textContent = formatTime(audio.duration);
    }
}

audio.addEventListener('timeupdate', updateSeekBar);

// Seek bar interaction for mini player
seekBar.addEventListener('mousedown', startSeeking);
seekBar.addEventListener('touchstart', startSeeking);

function startSeeking(e) {
    isSeeking = true;
    updateSeekPosition(e);
    
    document.addEventListener('mousemove', updateSeekPosition);
    document.addEventListener('touchmove', updateSeekPosition);
    document.addEventListener('mouseup', stopSeeking);
    document.addEventListener('touchend', stopSeeking);
}

function updateSeekPosition(e) {
    if (!isSeeking) return;
    
    const rect = seekBar.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    let position = (clientX - rect.left) / rect.width;
    position = Math.max(0, Math.min(1, position));
    
    const progress = position * 100;
    seekBarProgress.style.width = `${progress}%`;
    seekBarHandle.style.left = `${progress}%`;
    
    if (audio.duration) {
        audio.currentTime = position * audio.duration;
    }
}

function stopSeeking() {
    isSeeking = false;
    document.removeEventListener('mousemove', updateSeekPosition);
    document.removeEventListener('touchmove', updateSeekPosition);
    document.removeEventListener('mouseup', stopSeeking);
    document.removeEventListener('touchend', stopSeeking);
}

// Full player seek bar interaction
fullPlayerSeekBar.addEventListener('mousedown', startFullPlayerSeeking);
fullPlayerSeekBar.addEventListener('touchstart', startFullPlayerSeeking);

function startFullPlayerSeeking(e) {
    isFullPlayerSeeking = true;
    updateFullPlayerSeekPosition(e);
    
    document.addEventListener('mousemove', updateFullPlayerSeekPosition);
    document.addEventListener('touchmove', updateFullPlayerSeekPosition);
    document.addEventListener('mouseup', stopFullPlayerSeeking);
    document.addEventListener('touchend', stopFullPlayerSeeking);
}

function updateFullPlayerSeekPosition(e) {
    if (!isFullPlayerSeeking) return;
    
    const rect = fullPlayerSeekBar.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    let position = (clientX - rect.left) / rect.width;
    position = Math.max(0, Math.min(1, position));
    
    const progress = position * 100;
    fullPlayerSeekProgress.style.width = `${progress}%`;
    fullPlayerSeekHandle.style.left = `${progress}%`;
    
    if (audio.duration) {
        audio.currentTime = position * audio.duration;
        currentTimeEl.textContent = formatTime(audio.currentTime);
    }
}

function stopFullPlayerSeeking() {
    isFullPlayerSeeking = false;
    document.removeEventListener('mousemove', updateFullPlayerSeekPosition);
    document.removeEventListener('touchmove', updateFullPlayerSeekPosition);
    document.removeEventListener('mouseup', stopFullPlayerSeeking);
    document.removeEventListener('touchend', stopFullPlayerSeeking);
}

// Show handle on hover
seekBar.addEventListener('mouseenter', () => {
    if (!isSeeking) {
        seekBarHandle.style.opacity = '1';
    }
});

seekBar.addEventListener('mouseleave', () => {
    if (!isSeeking) {
        seekBarHandle.style.opacity = '0';
    }
});

fullPlayerSeekBar.addEventListener('mouseenter', () => {
    if (!isFullPlayerSeeking) {
        fullPlayerSeekHandle.style.opacity = '1';
    }
});

fullPlayerSeekBar.addEventListener('mouseleave', () => {
    if (!isFullPlayerSeeking) {
        fullPlayerSeekHandle.style.opacity = '0';
    }
});

// === BOTTOM NAVIGATION ===
const navLinks = document.querySelectorAll('.bottom-nav a');
navLinks.forEach(link => {
    link.addEventListener('click', function() {
        // Remove active class from all links
        navLinks.forEach(l => l.classList.remove('active'));
        // Add active class to clicked link
        this.classList.add('active');
        
        // Show the selected page
        const page = this.getAttribute('data-page');
        showPage(page);
    });
});

// === KEYBOARD FOCUS FIX VARIABLES ===
const searchBox = document.getElementById('searchBox');
const bottomNav = document.querySelector('.bottom-nav');
const content = document.getElementById('content');
const DEFAULT_CONTENT_PADDING = '120px';
const ADJUSTED_CONTENT_PADDING = '50px'; 

// === KEYBOARD FOCUS FIX LOGIC ===
searchBox.addEventListener('focus', () => {
    bottomNav.classList.add('nav-hidden');
    nowPlayingBar.style.bottom = '0px'; 
    content.style.paddingBottom = ADJUSTED_CONTENT_PADDING; 
});

searchBox.addEventListener('blur', () => {
    bottomNav.classList.remove('nav-hidden');
    nowPlayingBar.style.bottom = '70px'; 
    content.style.paddingBottom = DEFAULT_CONTENT_PADDING; 
});


// === SEARCH EVENT LISTENERS ===
document.getElementById('searchBox').addEventListener('input', function(e) {
    searchSongs(e.target.value);
});

document.getElementById('searchIcon').addEventListener('click', function() {
    const query = document.getElementById('searchBox').value;
    searchSongs(query);
});

document.getElementById('searchBox').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const query = document.getElementById('searchBox').value;
        searchSongs(query);
    }
});

// === LIBRARY FILTERS ===
const filterBtns = document.querySelectorAll('.filter-btn');
filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        filterBtns.forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        
        const filter = this.getAttribute('data-filter');
        applyLibraryFilter(filter);
    });
});

function applyLibraryFilter(filter) {
    let filteredSongs = [];
    
    switch(filter) {
        case 'all':
            filteredSongs = [
                ...(musicData.newReleases || []),
                ...(musicData.mixesForYou || [])
            ];
            break;
        case 'recent':
            filteredSongs = [...recentlyPlayed];
            break;
        case 'favorites':
            filteredSongs = [...favoriteSongs];
            break;
    }
    
    updateLibraryUI(filteredSongs);
}

// === BACK BUTTON HANDLING ===
function handleBackButton() {
    // 1. If search box is focused, blur it first (Hide keyboard/Show bottom nav)
    if (document.activeElement === searchBox) {
        searchBox.blur();
        return true;
    }
    
    // 2. If we're in full player, close it
    if (fullPlayer.classList.contains('show')) {
        hideFullPlayer();
        return true;
    }
    
    // 3. If we're on search page or library page, go back to home
    if (previousPage === 'search' || previousPage === 'library') {
        showPage('home');
        
        // ✅ FIX: Update bottom nav active state
        navLinks.forEach(l => l.classList.remove('active'));
        document.querySelector('.bottom-nav a[data-page="home"]').classList.add('active');
        return true;
    }
    
    // 4. If we are on the home page, exit confirmation
    if (previousPage === 'home') {
        if (confirm('Do you want to exit the app?')) {
            window.close();
            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100dvh;font-size:1.5rem;">App Closed</div>';
        }
        return true;
    }
    
    return false; // Back gesture not handled
}

// Handle browser back button
window.addEventListener('popstate', function(event) {
    console.log('Browser back button pressed');
    
    // 1. Close full player if open
    if (fullPlayer.classList.contains('show')) {
        hideFullPlayer();
        return;
    }
    
    // 2. If on search/library, go to home and update nav
    if (previousPage === 'search' || previousPage === 'library') {
        showPage('home');
        
        // ✅ FIX: Update bottom navigation
        navLinks.forEach(link => link.classList.remove('active'));
        document.querySelector('.bottom-nav a[data-page="home"]').classList.add('active');
        return;
    }
    
    // 3. If already on home, allow normal back behavior
    if (previousPage === 'home') {
        // Let the browser handle it (might go to previous page or exit)
        return;
    }
});

// Handle Android back button (for mobile apps)
document.addEventListener('backbutton', function() {
    if (!handleBackButton()) {
        if (typeof navigator !== 'undefined' && navigator.app) {
            navigator.app.exitApp();
        }
    }
}, false);

// Add event listener for Escape key (for desktop)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        handleBackButton();
    }
});

// Touch gesture for back navigation (swipe from left edge)
let touchStartX = 0;
let touchStartY = 0;
const SWIPE_THRESHOLD = 50; // Minimum swipe distance

document.addEventListener('touchstart', function(e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
});

document.addEventListener('touchend', function(e) {
    if (touchStartX === 0) return;
    
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    
    // Check if it's a horizontal swipe from left edge
    if (touchStartX < 50 && // Started from left edge
        Math.abs(deltaX) > SWIPE_THRESHOLD && // Minimum horizontal distance
        Math.abs(deltaX) > Math.abs(deltaY) && // More horizontal than vertical
        deltaX > 0) { // Swipe to the right (back gesture)
        
        handleBackButton();
    }
    
    // Reset touch start
    touchStartX = 0;
    touchStartY = 0;
});

// Initialize navigation state
window.history.replaceState({page: 'home'}, '', '');

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    // Initialize current playlist with new releases
    currentPlaylist = musicData.newReleases || [];
    
    // Populate sections with loaded data
    populateAllSections();
    
    // Populate library with all songs
    populateLibrary();
    
    // Show home page by default
    showPage('home');
});
</script>
</body>
</html>
